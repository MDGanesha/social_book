{% load static %}

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Profile - {{ user_profile.user.username }}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <style>
    body { background:#f3f6fb; color:#222; }
    .feature-photo { background: linear-gradient(90deg,#6dd5ed 0%, #2193b0 100%); padding:28px 0; color:white; }
    .profile-card { margin-top:-48px; }
    .profile-avatar-lg { width:160px; height:160px; object-fit:cover; border-radius:12px; border:6px solid white; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .stat-pill { background: rgba(255,255,255,0.12); padding:8px 12px; border-radius:999px; font-weight:600; color:white; }
    .post-card { border-radius:12px; overflow:hidden; }
    .post-img { width:100%; height:320px; object-fit:cover; display:block; }
    .comment-box { background:#fff; border-radius:10px; padding:12px; box-shadow: 0 2px 8px rgba(19,22,26,0.04); }
    .small-muted { color:#6c757d; font-size:.9rem; }
    .delete-btn { background:#ff4d4f; color:white; border:0; padding:6px 10px; border-radius:6px; }
    .comment-input { border-radius:999px; padding:8px 14px; border:1px solid #e6e9ee; width:100%; }
    .meta-row { gap:10px; align-items:center; display:flex; flex-wrap:wrap; }
    .suggestion-avatar { width:48px; height:48px; object-fit:cover; border-radius:10px; }
    @media (max-width:768px){
      .profile-avatar-lg { width:110px; height:110px; }
      .post-img { height:220px; }
    }
  </style>
</head>
<body>

<!-- Top hero -->
<section class="feature-photo">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="h3 mb-1">@{{ user_profile.user.username }}</h1>
        <p class="mb-2 small-muted">{{ user_profile.bio|default:"No bio yet." }}</p>
        <div class="d-flex gap-2">
          <span class="stat-pill">Posts: {{ user_post_length }}</span>
          <span class="stat-pill">Followers: {{ user_followers }}</span>
          <span class="stat-pill">Following: {{ user_following }}</span>
        </div>
      </div>

      <div class="col-md-4 text-md-end mt-3 mt-md-0">
        {% if request.user.is_authenticated and request.user.username == user_profile.user.username %}
          <a href="/settings" class="btn btn-outline-light btn-sm">Account settings</a>
        {% else %}
          <form action="/follow" method="POST" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="follower" value="{{ request.user.username }}">
            <input type="hidden" name="user" value="{{ user_object.username }}">
            <button type="submit" class="btn btn-light btn-sm">{{ button_text }}</button>
          </form>

          <!-- block/unblock (works if you added block/unblock views & urls) -->
          {% if is_blocking %}
            <form action="{% url 'unblock-user' %}" method="POST" class="d-inline ms-2">
              {% csrf_token %}
              <input type="hidden" name="blocked" value="{{ user_object.username }}">
              <button class="btn btn-outline-danger btn-sm">Unblock</button>
            </form>
          {% else %}
            <form action="{% url 'block-user' %}" method="POST" class="d-inline ms-2">
              {% csrf_token %}
              <input type="hidden" name="blocked" value="{{ user_object.username }}">
              <button class="btn btn-danger btn-sm">Block</button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Cover image (local uploaded screenshot) -->
<div class="container mt-3">
  <div class="card overflow-hidden mb-3">
    <figure class="m-0">
      <!-- local file path from your environment (will be transformed to URL by your deployment/tooling) -->
      <img src="/mnt/data/Screenshot 2025-11-23 062531.png" alt="cover" style="width:100%; height:220px; object-fit:cover;">
    </figure>
  </div>
</div>

<!-- Profile header card -->
<div class="container profile-card my-4">
  <div class="row">
    <div class="col-lg-3 text-center mb-4">
      <div class="card p-3 shadow-sm">
        <img src="{{ user_profile.profileimg.url }}" alt="Profile" class="profile-avatar-lg mx-auto d-block">
        <h5 class="mt-3 mb-0">@{{ user_profile.user.username }}</h5>
        <p class="small-muted mb-2">{{ user_profile.location|default:"" }}</p>
        <div class="d-flex justify-content-center gap-2 mt-2">
          {% if request.user.is_authenticated and request.user.username == user_profile.user.username %}
            <a href="/settings" class="btn btn-outline-secondary btn-sm">Edit profile</a>
          {% endif %}
          <a href="/" class="btn btn-outline-primary btn-sm">Home</a>
        </div>
      </div>

      <!-- suggestions (small) -->
      <div class="card mt-3 p-3 shadow-sm d-none d-md-block">
        <h6 class="mb-3">Suggested</h6>
        {% for s in suggestions_username_profile_list|slice:":4" %}
        <div class="d-flex align-items-center mb-2">
          <img src="{{ s.profileimg.url }}" class="suggestion-avatar me-2" alt="suggestion">
          <div>
            <a href="/profile/{{ s.user }}" class="fw-semibold text-decoration-none">{{ s.user }}</a>
            <div class="small-muted">{{ s.bio|truncatechars:30 }}</div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- posts + comments -->
    <div class="col-lg-6">
      {% if blocked_message %}
        <div class="alert alert-warning">{{ blocked_message }}</div>
      {% endif %}

      {% for post in user_posts %}
      <div class="card mb-4 post-card shadow-sm">
        <div class="card-body p-0">
          <div class="ratio ratio-16x9">
            <img src="{{ post.image.url }}" class="post-img" alt="post image">
          </div>

          <div class="p-3">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <a href="/profile/{{ post.user }}" class="fw-bold text-decoration-none">@{{ post.user }}</a>
                <div class="small-muted">{{ post.caption|default:"" }}</div>
              </div>

              <div class="meta-row">
                <!-- Like button / count (GET to keep existing like_post view) -->
                <form action="{% url 'like-post' %}" method="GET" style="margin:0;">
                  <input type="hidden" name="post_id" value="{{ post.id }}">
                  <button class="btn btn-sm btn-outline-secondary me-2" type="submit">
                    <i class="fa fa-thumbs-up me-1"></i>
                    {% if post.no_of_likes == 0 %}Like{% elif post.no_of_likes == 1 %}{{ post.no_of_likes }} Like{% else %}{{ post.no_of_likes }} Likes{% endif %}
                  </button>
                </form>

                <!-- Delete button (post owner or admin) -->
                {% if request.user.username == post.user or request.user.is_superuser %}
                  <form action="{% url 'delete-post' post.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button class="delete-btn" onclick="return confirm('Delete this post?');">Delete</button>
                  </form>
                {% endif %}
              </div>
            </div>

            <!-- comments list: use comments_by_post dict built in view -->
            <div class="mt-3 comment-box">
              {% comment %}
                comments_by_post is a dict mapping string(post.id) -> [Comment, ...]
                We'll iterate the dict items and render when key == pid.
              {% endcomment %}
              {% with pid=post.id|stringformat:"s" %}
                {% for key, clist in comments_by_post.items %}
                  {% if key == pid %}
                    {% for c in clist %}
                      <div class="mb-2">
                        <div class="d-flex justify-content-between">
                          <div>
                            <strong>{{ c.user }}</strong>
                            <span class="small-muted ms-2">{{ c.body }}</span>
                          </div>
                          <div class="small-muted">{{ c.timestamp|timesince }} ago</div>
                        </div>
                      </div>
                    {% endfor %}
                  {% endif %}
                {% endfor %}
                {# If no matching key exists nothing renders — optionally show message #}
                {% comment %} show "No comments" message if we want: check length via attached list in view or in template by searching keys. {% endcomment %}
              {% endwith %}
            </div>

            <!-- add comment -->
            <form action="{% url 'add_comment' %}" method="POST" class="mt-3">
              {% csrf_token %}
              <input type="hidden" name="post_id" value="{{ post.id }}">
              <div class="input-group">
                <input type="text" name="body" class="comment-input" placeholder="Add a comment..." required>
                <button class="btn btn-success" type="submit">Comment</button>
              </div>
            </form>

          </div>
        </div>
      </div>
      {% empty %}
        <div class="card mb-4 p-4 text-center">
          <p class="mb-0 small-muted">This user has no posts yet.</p>
        </div>
      {% endfor %}
    </div>

    <!-- right column: about & quick actions -->
    <div class="col-lg-3">
      <div class="card p-3 shadow-sm mb-3">
        <h6 class="mb-2">About</h6>
        <p class="small-muted mb-1"><strong>Joined:</strong> {{ user_profile.user.date_joined|date:"M Y" }}</p>
        <p class="small-muted mb-1"><strong>Location:</strong> {{ user_profile.location|default:"Unknown" }}</p>
        <p class="small-muted"><strong>Bio</strong><br>{{ user_profile.bio|default:"—" }}</p>
      </div>

      <div class="card p-3 shadow-sm">
        <h6 class="mb-2">Quick actions</h6>
        <div class="d-grid gap-2">
          <a href="/profile/{{ user_profile.user.username }}" class="btn btn-outline-primary btn-sm">View profile</a>
          {% if request.user.is_authenticated and request.user.username == user_profile.user.username %}
            <a href="/settings" class="btn btn-primary btn-sm">Edit profile</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/script.js' %}"></script>

</body>
</html>
